<!DOCTYPE html>
<!--
    Miniport by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
    <title>Peter Bouda - Onsite and online AI trainings for your team</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="" />
    <meta
      name="keywords"
      content="AI, LLM, Natural Language Processing, Python, Trainings, Workshops, Software Development, Consultant"
    />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="theme-color" content="#ffffff" />

    <!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
    <script src="/theme/js/jquery.min.js"></script>
    <script src="/theme/js/skel.min.js"></script>
    <script src="/theme/js/init.js"></script>
    <link
      href="https://www.peterbouda.eu/feeds/all.atom.xml"
      type="application/atom+xml"
      rel="alternate"
      title="Peter Bouda Atom Feed"
    />
     <link
      href="https://www.peterbouda.eu/feeds/all.rss"
      type="application/rss+xml"
      rel="alternate"
      title="Peter Bouda RSS Feed"
    />

    <link rel="stylesheet" href="/theme/css/pygment.css" />

    <noscript>
      <link rel="stylesheet" href="/theme/css/skel.css" />
      <link rel="stylesheet" href="/theme/css/style.css" />
      <link rel="stylesheet" href="/theme/css/style-desktop.css" />
    </noscript>

    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Person",
        "name": "Peter Bouda",
        "url": "https://www.peterbouda.eu",
        "jobTitle": "Working on Free and Open Source AI Projects",
        "alumniOf": "LMU Munich",
        "gender": "male",
        "image": "https://www.peterbouda.eu/theme/images/pic00.jpg",
        "sameAs": ["https://github.com/pbouda"]
      }
    </script>

    <!--[if lte IE 8
      ]><link rel="stylesheet" href="/theme/css/ie/v8.css"
    /><![endif]-->
    <!--[if lte IE 9
      ]><link rel="stylesheet" href="/theme/css/ie/v9.css"
    /><![endif]-->
  </head>
  <body>
<!-- Nav -->
<nav id="nav">
  <ul class="container">
    <li><a href="/#top">Home</a></li>
    <li><a href="/#workshops">AI Workshops</a></li>
    <li><a href="/#portfolio">Portfolio</a></li>
    <li><a href="/#feed">Blog</a></li>
    <li><a href="/#contact">Contact</a></li>
  </ul>
</nav> <section id="content" class="body">
  <article class="h-entry">
    <header>
      <h1 class="entry-title e-title">
        <a
          class="p-name u-url"
          href="https://www.peterbouda.eu/running-tinygrad-with-cuda-on-nixos.html"
          rel="bookmark"
          title="Permalink to Running tinygrad with CUDA onÂ NixOS"
          >Running tinygrad with <span class="caps">CUDA</span> on&nbsp;NixOS</a
        >
      </h1>
    </header>

    <div class="entry-content e-content container">
      <div class="row">
        <div class="8u">
 <footer class="post-info">
  <p>
    Published by
    <a href="http://www.peterbouda.eu" class="p-author">Peter Bouda</a> at
    <b
      ><time class="dt-published" datetime="2025-06-16 08:40:00+01:00"
        >seg 16 junho 2025</time
      ></b
    >
    in
    <b
      ><a class="p-category" href="/category/ai.html"
        >AI</a
      ></b
    >.
  </p>

  
  </p>
</footer>

<!-- /.post-info --> <p>I started to play around with NixOS a few weeks ago and until now I am quite happy with it. I installed it on an older
<span class="caps">PC</span> with a Geforce <span class="caps">GT</span> 1030 and wanted to see if I get tinygrad running with the <span class="caps">CUDA</span> back-end on it. I learned about
nix-shell and, after a while, was able to set up such a shell that supports tinygrad on <span class="caps">CUDA</span>. I was not able to find
examples that worked directly for my use case, so I will post that here, for future reference. The main customizations
for me&nbsp;where:</p>
<ul>
<li>Adding clang as the shell&nbsp;compiler</li>
<li>LD_LIBRARY_PATH&nbsp;needs <code>${pkgs.cudatoolkit}/lib</code> for <code>libnvrtc.so</code></li>
<li>I&nbsp;added <code>NIX_ENFORCE_NO_NATIVE=0</code> so that tinygrad can&nbsp;pass <code>-march=native</code> to&nbsp;clang</li>
</ul>
<p>Here is my complete&nbsp;nix-shell:</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="n">clangStdenv</span><span class="o">.</span><span class="n">mkDerivation</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;clang-nix-shell&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="c1"># nativeBuildInputs is usually what you want -- tools you need to run</span>
<span class="w">  </span><span class="n">nativeBuildInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">pkgs</span><span class="o">.</span><span class="n">buildPackages</span><span class="p">;</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="n">python312</span>
<span class="w">    </span><span class="n">uv</span>
<span class="w">  </span><span class="p">];</span>
<span class="w">  </span><span class="n">buildInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">pkgs</span><span class="p">;</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="n">git</span><span class="w"> </span><span class="n">gitRepo</span><span class="w"> </span><span class="n">gnupg</span><span class="w"> </span><span class="n">autoconf</span><span class="w"> </span><span class="n">curl</span>
<span class="w">    </span><span class="n">procps</span><span class="w"> </span><span class="n">gnumake</span><span class="w"> </span><span class="n">util</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="n">gperf</span><span class="w"> </span><span class="n">unzip</span>
<span class="w">    </span><span class="n">cudatoolkit</span><span class="w"> </span><span class="n">linuxPackages</span><span class="o">.</span><span class="n">nvidia_x11</span>
<span class="w">    </span><span class="n">libGLU</span><span class="w"> </span><span class="n">libGL</span>
<span class="w">    </span><span class="n">xorg</span><span class="o">.</span><span class="n">libXi</span><span class="w"> </span><span class="n">xorg</span><span class="o">.</span><span class="n">libXmu</span><span class="w"> </span><span class="n">freeglut</span>
<span class="w">    </span><span class="n">xorg</span><span class="o">.</span><span class="n">libXext</span><span class="w"> </span><span class="n">xorg</span><span class="o">.</span><span class="n">libX11</span><span class="w"> </span><span class="n">xorg</span><span class="o">.</span><span class="n">libXv</span><span class="w"> </span><span class="n">xorg</span><span class="o">.</span><span class="n">libXrandr</span><span class="w"> </span><span class="n">zlib</span>
<span class="w">    </span><span class="n">ncurses5</span><span class="w"> </span><span class="n">stdenv</span><span class="o">.</span><span class="n">cc</span><span class="w"> </span><span class="n">binutils</span>
<span class="w">  </span><span class="p">];</span>
<span class="w">  </span><span class="n">shellHook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">CUDA_PATH</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">pkgs</span><span class="o">.</span><span class="n">cudatoolkit</span><span class="p">}</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">pkgs</span><span class="o">.</span><span class="n">linuxPackages</span><span class="o">.</span><span class="n">nvidia_x11</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="n">pkgs</span><span class="o">.</span><span class="n">ncurses5</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="n">pkgs</span><span class="o">.</span><span class="n">cudatoolkit</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">EXTRA_LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L/lib -L$</span><span class="si">{pkgs.linuxPackages.nvidia_x11}</span><span class="s2">/lib&quot;</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">EXTRA_CCFLAGS</span><span class="o">=</span><span class="s2">&quot;-I/usr/include&quot;</span>
<span class="w">    </span><span class="n">NIX_ENFORCE_NO_NATIVE</span><span class="o">=</span><span class="mi">0</span>
<span class="w">  </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>You might also need to remove&nbsp;the <code>--target</code> argument to clang from the&nbsp;tinygrad <code>runtime/ops_cpu.py</code>. It gave me
warning, but I am not sure if it actually <a href="https://github.com/NixOS/nixpkgs/pull/323869">breaks things</a>:</p>
<div class="highlight"><pre><span></span><code><span class="mf">14</span><span class="n">c14</span>
<span class="o">&lt;</span><span class="w">     </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[&#39;</span><span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">native</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="err">&#39;</span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="err">{</span><span class="n">target</span><span class="err">}</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">elf</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">O2</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">fPIC</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">ffreestanding</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="kd">fn</span><span class="n">o</span><span class="o">-</span><span class="n">math</span><span class="o">-</span><span class="n">errno</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">nostdlib</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="kd">fn</span><span class="n">o</span><span class="o">-</span><span class="n">ident</span><span class="err">&#39;]</span>
<span class="o">---</span>
<span class="o">&gt;</span><span class="w">     </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[&#39;</span><span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">native</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">O2</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">fPIC</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">ffreestanding</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="kd">fn</span><span class="n">o</span><span class="o">-</span><span class="n">math</span><span class="o">-</span><span class="n">errno</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">nostdlib</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="kd">fn</span><span class="n">o</span><span class="o">-</span><span class="n">ident</span><span class="err">&#39;]</span>
</code></pre></div>
          <div id="comments">
            <script
              src="https://utteranc.es/client.js"
              repo="pbouda/peterbouda.eu"
              issue-term="pathname"
              label="Comment"
              theme="github-light"
              crossorigin="anonymous"
              async
            ></script>
          </div>
        </div>
        <!-- /.entry-content -->

        <div class="4u">
          <article class="box style2">
            <div>
              <img
                style="border-radius: 50%; width: 80%"
                src="theme/images/pic00.jpg"
                alt=""
              />
            </div>
            <h3>About me</h3>
            <p>
              I work since more than 20 years as a developer, product manager
              and AI lead with language technologies. Starting with speech
              recognition and machine translation I now focus on education in
              semantic technologies and LLMs.
            </p>
            <p>Check out my <a href="/#workshops">AI trainings</a>.</p>
            <p><a href="/#contact">Contact me</a> and book your training.</p>
          </article>
        </div>
      </div>
      <!-- end row -->
    </div>
    <!-- end container -->
  </article>
</section>

 <!-- Contact -->
<div class="wrapper style4" id="contact">
  <article class="container 75%">
    <div class="row">
      <div class="12u">
        <h2>Send me a message and I will get back to you.</h2>
        <ul class="social">
          <li>
            <a href="mailto:pbouda@outlook.com" class="icon fa-envelope-o"
              ><span class="label">Mail</span></a
            >
          </li>
          <li>
            <a href="tel:+351917403181" class="icon fa-phone"
              ><span class="label">Phone</span></a
            >
          </li>
        </ul>
        <div><a href="mailto:pbouda@outlook.com">pbouda@outlook.com</a></div>
        <div><a href="tel:+351917403181">+351 917403181</a></div>
        <div>Lisbon, Portugal</div>
        <br />
        <ul class="social">
          <li>
            <a
              href="https://www.linkedin.com/in/peter-bouda/"
              class="icon fa-linkedin"
              ><span class="label">LinkedIn</span></a
            >
          </li>
          <li>
            <a href="https://github.com/pbouda" class="icon fa-github"
              ><span class="label">Github</span></a
            >
          </li>
          <li>
            <a
              href="https://www.youtube.com/@peterbouda6349"
              class="icon fa-youtube"
              ><span class="label">Youtube</span></a
            >
          </li>
          <li>
            <a href="https://www.peterbouda.eu/feeds/all.rss" class="icon fa-rss"
              ><span class="label">RSS</span></a
            >
          </li>
        </ul>
        <hr />
      </div>
    </div>

    <footer>
      <ul id="copyright">
        <li>&copy; Peter Bouda. All rights reserved.</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
      </ul>
    </footer>
  </article>
</div>  </body>
</html>